{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - FinSage</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" type="text/css" href="{% static 'css/dash.css' %}">
</head>
<body>
    <header class="header">
        <div class="logo-container">
            <span class="brand-name">FinSage</span>
        </div>
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle text-white" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user-circle me-1"></i> My Account
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="{% url 'finances:upload_bill' %}"><i class="fas fa-receipt me-2"></i>Upload Bill</a></li>
                                <li><a class="dropdown-item" href="{% url 'finances:export_expenses' %}"><i class="fas fa-file-export me-2"></i>Export Expenses</a></li>
                                <li><a class="dropdown-item" href="{% url 'finances:add_income' %}"><i class="fas fa-plus-circle me-2"></i>Add Income</a></li>
                                <li><a class="dropdown-item" href="{% url 'finances:add_expense' %}"><i class="fas fa-minus-circle me-2"></i>Add Expense</a></li>
                                <li><a class="dropdown-item" href="#"><i class="fas fa-chart-line me-2"></i>Analysis</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="/logout"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <div class="container">
        <h1 class="section-title animate__animated animate__fadeIn"> Dashboard</h1>

        <div id="message-container" class="message-container">
            {% if messages %}
                {% for message in messages %}
                    {% if forloop.last %}
                        <div class="message {{ message.tags }} animate__animated animate__fadeIn">
                            <span class="message-close" onclick="closeMessage(this)">&times;</span>
                            {{ message }}
                        </div>
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>

        <div class="stats-cards animate__animated animate__fadeInUp">
            <div class="stat-card" id="income-card">
                <h4>Total Income</h4>
                <div class="amount" id="income-counter">₹{{ total_income|floatformat:2}}</div>
            </div>
            <div class="stat-card" id="expense-card">
                <h4>Total Expenses</h4>
                <div class="amount" id="expense-counter">₹{{ total_expenses|floatformat:2 }}</div>
            </div>
            <div class="stat-card" id="balance-card">
                <h4>Balance</h4>
                <div class="amount" id="balance-counter">₹{{ balance|floatformat:2  }}</div>
            </div>
        </div>
        
        <!-- Charts Row -->
        <div class="row mb-4 animate__animated animate__fadeIn">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>Income and Expenses by Category</h5>
                    <canvas id="categoryChart" width="400" height="250"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>Income vs Expenses Trend</h5>
                    <canvas id="trendChart" width="400" height="250"></canvas>
                </div>
            </div>
        </div>

        <h3 class="section-title animate__animated animate__fadeIn">Income Entries</h3>
        <div class="table-container animate__animated animate__fadeInUp">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Amount</th>
                            <th>Description</th>
                            <th>Date</th>
                            <th>Category</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if incomes %}
                            {% for income in incomes %}
                                <tr class="animate__animated animate__fadeIn" style="--animate-delay: {{ forloop.counter }}00ms">
                                    <td>₹{{ income.amount }}</td>
                                    <td>{{ income.description }}</td>
                                    <td>{{ income.date }}</td>
                                    <td>{{ income.category }}</td>
                                    <td>
                                        <a href="{% url 'finances:edit_income' income.id %}" class="btn btn-warning btn-custom">
                                            <i class="fas fa-edit me-1"></i> Edit
                                        </a>
                                        <a href="{% url 'finances:delete_income' income.id %}" class="btn btn-danger btn-custom" onclick="return confirmDelete('income')">
                                            <i class="fas fa-trash me-1"></i> Delete
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="4" class="text-center">No income entries found.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <h3 class="section-title mt-4 animate__animated animate__fadeIn">Expense Management</h3>

        <div id="search-section" class="search-container p-3 animate__animated animate__fadeIn">
            <h5 class="mb-3"><i class="fas fa-filter me-2"></i>Filter Expenses</h5>
            <form method="GET" action="" class="row g-2">
                <div class="col-md-4">
                    <label for="month" class="form-label">Month</label>
                    <select name="month" id="month" class="form-select">
                        <option value="">Default</option>
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
        
                <div class="col-md-4">
                    <label for="year" class="form-label">Year</label>
                    <select name="year" id="year" class="form-select">
                        <option value="">All Years</option>
                        {% for year in available_years %}
                            <option value="{{ year }}">{{ year }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-4">
                    <label for="date" class="form-label">Date</label>
                    <input type="date" name="date" id="date" class="form-control" placeholder="Search by date" value="{{ request.GET.date|default:'' }}">
                </div>
        
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100"><i class="fas fa-search me-2"></i> Search</button>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <a href="{% url 'finances:dashboard' %}" class="btn btn-secondary w-100">
                        <i class="fas fa-sync-alt me-2"></i> Reset
                    </a>
                </div>
            </form>

            <div class="active-filters mt-3" id="activeFilters">
                <!-- Active filters will be displayed here -->
            </div>
        </div>
    
        {% regroup expenses by month_year as expense_list %}
        
        {% for month_expenses in expense_list %}
        <div class="expense-group animate__animated animate__fadeIn" style="--animate-delay: {{ forloop.counter }}00ms">
            <div id="expense-{{ forloop.counter }}" class="collapse show">
                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                    <th>Category</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for expense in month_expenses.list %}
                                <tr>
                                    <td>{{ expense.date|date:"d M Y" }}</td>
                                    <td>₹{{ expense.amount }}</td>
                                    <td>{{ expense.description }}</td>
                                    <td>{{ expense.category }}</td>
                                    <td>
                                        <a href="{% url 'finances:edit_expense' expense.id %}" class="btn btn-warning btn-custom">
                                            <i class="fas fa-edit me-1"></i> Edit
                                        </a>
                                        <a href="{% url 'finances:delete_expense' expense.id %}" class="btn btn-danger btn-custom" onclick="return confirmDelete('expense')">
                                            <i class="fas fa-trash me-1"></i> Delete
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="expense-group animate__animated animate__fadeIn">
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table mb-0">
                        <tbody>
                            <tr>
                                <td colspan="5" class="text-center">No expense entries found.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endfor %}

        <div class="pagination animate__animated animate__fadeIn">
            {% if expenses.has_previous %}
                <button onclick="location.href='?page={{ expenses.previous_page_number }}&month={{ request.GET.month }}&year={{ request.GET.year }}&category={{ request.GET.category }}'">
                    <i class="fas fa-chevron-left me-1"></i> Previous
                </button>
            {% endif %}
            
            <button class="active">{{ expenses.number }}</button>
            
            {% if expenses.has_next %}
                <button onclick="location.href='?page={{ expenses.next_page_number }}&month={{ request.GET.month }}&year={{ request.GET.year }}&category={{ request.GET.category }}'">
                    Next <i class="fas fa-chevron-right ms-1"></i>
                </button>
            {% endif %}
        </div>
    </div>

    {{ chart_labels|json_script:"chart-labels" }}
    {{ chart_income|json_script:"chart-income" }}
    {{ chart_expenses|json_script:"chart-expenses" }}
    {{ categories|json_script:"chart-categories" }}
    {{ income_data|json_script:"chart-income-data" }}
    {{ expense_data|json_script:"chart-expense-data" }}    
    <footer class="footer">
        <div class="container">
            <p>&copy; 2021 FinSage. All Rights Reserved.</p>
        </div>
    </footer>

    <!-- External JavaScript Files -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
    <script src="{% static 'js/dash.js' %}"></script>
    <script>
        function closeMessage(closeBtn) {
            let messageDiv = closeBtn.parentElement;
            messageDiv.classList.add("animate__fadeOut"); 
            setTimeout(() => messageDiv.style.display = "none", 100);
        }
    
        function confirmDelete(type) {
            return confirm(`Are you sure you want to delete this ${type}?`);
        }
    
        document.addEventListener('DOMContentLoaded', function() {
            // Trend Chart
            var ctx = document.getElementById('trendChart').getContext('2d');
            
            var chartLabels = JSON.parse(document.getElementById('chart-labels').textContent);
            var chartIncome = JSON.parse(document.getElementById('chart-income').textContent);
            var chartExpenses = JSON.parse(document.getElementById('chart-expenses').textContent);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [
                        {
                            label: 'Income',
                            data: chartIncome,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: true
                        },
                        {
                            label: 'Expenses',
                            data: chartExpenses,
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    var label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('en-IN', { 
                                            style: 'currency', 
                                            currency: 'INR',
                                            maximumFractionDigits: 0
                                        }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
    
            // Category Chart - Enhanced Version
        var ctxCategory = document.getElementById('categoryChart').getContext('2d');
    
        var categories = JSON.parse(document.getElementById('chart-categories').textContent);
        var incomeData = JSON.parse(document.getElementById('chart-income-data').textContent);
        var expenseData = JSON.parse(document.getElementById('chart-expense-data').textContent);
    
        // Calculate net values for data labels
        var netValues = incomeData.map((income, index) => income - expenseData[index]);
    
        // Custom gradient backgrounds
        function createGradient(ctx, color1, color2) {
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, color1);
            gradient.addColorStop(1, color2);
            return gradient;
        }
    
        const incomeGradient = createGradient(ctxCategory, 'rgba(40, 167, 69, 0.8)', 'rgba(40, 167, 69, 0.3)');
        const expenseGradient = createGradient(ctxCategory, 'rgba(220, 53, 69, 0.8)', 'rgba(220, 53, 69, 0.3)');
    
        new Chart(ctxCategory, {
            type: 'bar',
            data: {
                labels: categories,
                datasets: [
                    {
                        label: 'Income',
                        data: incomeData,
                        backgroundColor: incomeGradient,
                        borderColor: '#28a745',
                        borderWidth: 2,
                        borderRadius: 6,
                        hoverBorderWidth: 3,
                        hoverBorderColor: '#1d9438'
                    },
                    {
                        label: 'Expenses',
                        data: expenseData,
                        backgroundColor: expenseGradient,
                        borderColor: '#dc3545',
                        borderWidth: 2,
                        borderRadius: 6,
                        hoverBorderWidth: 3,
                        hoverBorderColor: '#c82333'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                },
                layout: {
                    padding: {
                        top: 10,
                        right: 25,
                        bottom: 10,
                        left: 25
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(200, 200, 200, 0.2)',
                            drawBorder: false
                        },
                        ticks: {
                            callback: function(value) {
                                return new Intl.NumberFormat('en-IN', { 
                                    style: 'currency', 
                                    currency: 'INR',
                                    maximumFractionDigits: 0
                                }).format(value);
                            },
                            font: {
                                weight: 'bold'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Amount (₹)',
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            padding: {top: 10, bottom: 10}
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                weight: 'bold'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Category',
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            padding: {top: 10, bottom: 10}
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            boxWidth: 15,
                            usePointStyle: true,
                            pointStyle: 'rectRounded',
                            padding: 20,
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 14
                        },
                        padding: 12,
                        cornerRadius: 6,
                        callbacks: {
                            label: function(context) {
                                var label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('en-IN', { 
                                        style: 'currency', 
                                        currency: 'INR',
                                        maximumFractionDigits: 0
                                    }).format(context.parsed.y);
                                }
                                return label;
                            },
                            afterBody: function(tooltipItems) {
                                const idx = tooltipItems[0].dataIndex;
                                const net = netValues[idx];
                                const netFormatted = new Intl.NumberFormat('en-IN', { 
                                    style: 'currency', 
                                    currency: 'INR',
                                    maximumFractionDigits: 0
                                }).format(net);
                                
                                return `Net: ${netFormatted} (${net >= 0 ? '+' : ''}${(net / expenseData[idx] * 100).toFixed(1)}%)`;
                            }
                        }
                    },
                    datalabels: {
                        display: function(context) {
                            return context.dataset.data[context.dataIndex] > 0;
                        },
                        color: function(context) {
                            return context.dataset.borderColor;
                        },
                        font: {
                            weight: 'bold'
                        },
                        formatter: function(value) {
                            if (value > 10000) {
                                return new Intl.NumberFormat('en-IN', { 
                                    style: 'currency', 
                                    currency: 'INR',
                                    notation: 'compact',
                                    compactDisplay: 'short',
                                    maximumFractionDigits: 1
                                }).format(value);
                            }
                            return '';
                        }
                    }
                }
            },
            plugins: [ChartDataLabels] // Make sure to include this library in your HTML
        });
    
        // FAB Button functionality - Enhanced
        const fabButton = document.getElementById('fabButton');
        const fabOptions = document.getElementById('fabOptions');
    
        if (fabButton) {
            fabButton.addEventListener('click', function() {
                fabOptions.classList.toggle('active');
            });
            
            // Auto-hide FAB options when clicking elsewhere
            document.addEventListener('click', function(event) {
                if (!fabButton.contains(event.target) && !fabOptions.contains(event.target)) {
                    fabOptions.classList.remove('active');
                }
            });
        }
    
        // Add download functionality
        document.getElementById('downloadChart').addEventListener('click', function() {
            const canvas = document.getElementById('categoryChart');
            const image = canvas.toDataURL('image/png', 1.0);
            const link = document.createElement('a');
            link.download = 'category-financial-chart.png';
            link.href = image;
            link.click();
        });
    
        // Add chart animation refresh button
        document.getElementById('refreshChart').addEventListener('click', function() {
            const chart = Chart.getChart('categoryChart');
            chart.update('none');
            chart.options.animation.duration = 1000;
            chart.reset();
            setTimeout(() => {
                chart.update();
            }, 100);
        });
    });
    </script>
</body>
</html>

{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - FinSage</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" type="text/css" href="{% static 'css/dash.css' %}">
</head>
<body>
    <header class="header">
        <div class="logo-container">
            <span class="brand-name">FinSage</span>
        </div>
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle text-white" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user-circle me-1"></i> My Account
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="{% url 'finances:upload_bill' %}"><i class="fas fa-receipt me-2"></i>Upload Bill</a></li>
                                <li><a class="dropdown-item" href="#" id="exportPdfBtn"><i class="fas fa-file-export me-2"></i>Export Report</a></li>
                                <li><a class="dropdown-item" href="{% url 'finances:add_income' %}"><i class="fas fa-plus-circle me-2"></i>Add Income</a></li>
                                <li><a class="dropdown-item" href="{% url 'finances:add_expense' %}"><i class="fas fa-minus-circle me-2"></i>Add Expense</a></li>
                                <li><a class="dropdown-item" href="{% url 'finances:analysis' %}"><i class="fas fa-chart-line me-2"></i>Analysis</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="/logout"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <div class="container">
        <h1 class="section-title animate__animated animate__fadeIn"> Dashboard</h1>

        <div id="message-container" class="message-container">
            {% if messages %}
                {% for message in messages %}
                    {% if forloop.last %}
                        <div class="message {{ message.tags }} animate__animated animate__fadeIn">
                            <span class="message-close" onclick="closeMessage(this)">&times;</span>
                            {{ message }}
                        </div>
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>

        <div class="stats-cards animate__animated animate__fadeInUp">
            <div class="stat-card" id="income-card">
                <h4>Total Income</h4>
                <div class="amount" id="income-counter">₹{{ total_income|floatformat:2}}</div>
            </div>
            <div class="stat-card" id="expense-card">
                <h4>Total Expenses</h4>
                <div class="amount" id="expense-counter">₹{{ total_expenses|floatformat:2 }}</div>
            </div>
            <div class="stat-card" id="balance-card">
                <h4>Balance</h4>
                <div class="amount" id="balance-counter">₹{{ balance|floatformat:2  }}</div>
            </div>
        </div>
        
        <!-- Charts Row -->
        <div class="row mb-4 animate__animated animate__fadeIn">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>Income and Expenses by Category</h5>
                    <canvas id="categoryChart" width="400" height="250"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>Income vs Expenses Trend</h5>
                    <canvas id="trendChart" width="400" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Search & Filter Section -->
        <div id="search-section" class="search-container p-3 animate__animated animate__fadeIn mb-4">
            <ul class="nav nav-tabs" id="searchTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="expense-search-tab" data-bs-toggle="tab" data-bs-target="#expense-search" type="button" role="tab" aria-controls="expense-search" aria-selected="true">
                        <i class="fas fa-shopping-cart me-2"></i>Search Expenses
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="income-search-tab" data-bs-toggle="tab" data-bs-target="#income-search" type="button" role="tab" aria-controls="income-search" aria-selected="false">
                        <i class="fas fa-wallet me-2"></i>Search Income
                    </button>
                </li>
            </ul>
            
            <div class="tab-content mt-3" id="searchTabContent">
                <!-- Expense Search Tab -->
                <div class="tab-pane fade show active" id="expense-search" role="tabpanel" aria-labelledby="expense-search-tab">
                    <form method="GET" action="" class="row g-2" id="expense-search-form">
                        <input type="hidden" name="search_type" value="expense">
                        <div class="col-md-3">
                            <label for="expense_month" class="form-label">Month</label>
                            <select name="month" id="expense_month" class="form-select">
                                <option value="">All Months</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                
                        <div class="col-md-3">
                            <label for="expense_year" class="form-label">Year</label>
                            <select name="year" id="expense_year" class="form-select">
                                <option value="">All Years</option>
                                {% for year in available_years %}
                                    <option value="{{ year }}">{{ year }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label for="expense_date" class="form-label">Date</label>
                            <input type="date" name="date" id="expense_date" class="form-control" value="{{ request.GET.date|default:'' }}">
                        </div>

                        <div class="col-md-3">
                            <label for="expense_category" class="form-label">Category</label>
                            <select name="category" id="expense_category" class="form-select">
                                <option value="">All Categories</option>
                                {% for category in expense_categories %}
                                    <option value="{{ category }}">{{ category }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label for="expense_min_amount" class="form-label">Min Amount</label>
                            <input type="number" name="min_amount" id="expense_min_amount" class="form-control" value="{{ request.GET.min_amount|default:'' }}">
                        </div>

                        <div class="col-md-3">
                            <label for="expense_max_amount" class="form-label">Max Amount</label>
                            <input type="number" name="max_amount" id="expense_max_amount" class="form-control" value="{{ request.GET.max_amount|default:'' }}">
                        </div>

                        <div class="col-md-6">
                            <label for="expense_keyword" class="form-label">Keyword</label>
                            <input type="text" name="keyword" id="expense_keyword" class="form-control" placeholder="Search by description" value="{{ request.GET.keyword|default:'' }}">
                        </div>
                
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100"><i class="fas fa-search me-2"></i> Search</button>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <a href="{% url 'finances:dashboard' %}" class="btn btn-secondary w-100">
                                <i class="fas fa-sync-alt me-2"></i> Reset
                            </a>
                        </div>
                    </form>
                </div>
                
                <!-- Income Search Tab -->
                <div class="tab-pane fade" id="income-search" role="tabpanel" aria-labelledby="income-search-tab">
                    <form method="GET" action="" class="row g-2" id="income-search-form">
                        <input type="hidden" name="search_type" value="income">
                        <div class="col-md-3">
                            <label for="income_month" class="form-label">Month</label>
                            <select name="month" id="income_month" class="form-select">
                                <option value="">All Months</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                
                        <div class="col-md-3">
                            <label for="income_year" class="form-label">Year</label>
                            <select name="year" id="income_year" class="form-select">
                                <option value="">All Years</option>
                                {% for year in available_years %}
                                    <option value="{{ year }}">{{ year }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label for="income_date" class="form-label">Date</label>
                            <input type="date" name="date" id="income_date" class="form-control" value="{{ request.GET.date|default:'' }}">
                        </div>

                        <div class="col-md-3">
                            <label for="income_category" class="form-label">Category</label>
                            <select name="category" id="income_category" class="form-select">
                                <option value="">All Categories</option>
                                {% for category in income_categories %}
                                    <option value="{{ category }}">{{ category }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label for="income_min_amount" class="form-label">Min Amount</label>
                            <input type="number" name="min_amount" id="income_min_amount" class="form-control" value="{{ request.GET.min_amount|default:'' }}">
                        </div>

                        <div class="col-md-3">
                            <label for="income_max_amount" class="form-label">Max Amount</label>
                            <input type="number" name="max_amount" id="income_max_amount" class="form-control" value="{{ request.GET.max_amount|default:'' }}">
                        </div>

                        <div class="col-md-6">
                            <label for="income_keyword" class="form-label">Keyword</label>
                            <input type="text" name="keyword" id="income_keyword" class="form-control" placeholder="Search by description" value="{{ request.GET.keyword|default:'' }}">
                        </div>
                
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100"><i class="fas fa-search me-2"></i> Search</button>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <a href="{% url 'finances:dashboard' %}" class="btn btn-secondary w-100">
                                <i class="fas fa-sync-alt me-2"></i> Reset
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <div class="active-filters mt-3" id="activeFilters">
                <!-- Active filters will be displayed here -->
            </div>
        </div>

        <h3 class="section-title animate__animated animate__fadeIn">Income Entries</h3>
        <div class="table-container animate__animated animate__fadeInUp">
            <div class="table-actions mb-3">
                <button class="btn btn-success" id="exportIncomeBtn">
                    <i class="fas fa-file-export me-2"></i>Export Income Data
                </button>
            </div>
            <div class="table-responsive">
                <table class="table" id="incomeTable">
                    <thead>
                        <tr>
                            <th>Amount</th>
                            <th>Description</th>
                            <th>Date</th>
                            <th>Category</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if incomes %}
                            {% for income in incomes %}
                                <tr class="animate__animated animate__fadeIn" style="--animate-delay: {{ forloop.counter }}00ms">
                                    <td>₹{{ income.amount }}</td>
                                    <td>{{ income.description }}</td>
                                    <td>{{ income.date }}</td>
                                    <td>{{ income.category }}</td>
                                    <td>
                                        <a href="{% url 'finances:edit_income' income.id %}" class="btn btn-warning btn-custom">
                                            <i class="fas fa-edit me-1"></i> Edit
                                        </a>
                                        <a href="{% url 'finances:delete_income' income.id %}" class="btn btn-danger btn-custom" onclick="return confirmDelete('income')">
                                            <i class="fas fa-trash me-1"></i> Delete
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="5" class="text-center">No income entries found.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <h3 class="section-title mt-4 animate__animated animate__fadeIn">Expense Management</h3>
        <div class="table-actions mb-3">
            <button class="btn btn-danger" id="exportExpenseBtn">
                <i class="fas fa-file-export me-2"></i>Export Expense Data
            </button>
        </div>
        
        {% regroup expenses by month_year as expense_list %}
        
        {% for month_expenses in expense_list %}
        <div class="expense-group animate__animated animate__fadeIn" style="--animate-delay: {{ forloop.counter }}00ms">
            <div id="expense-{{ forloop.counter }}" class="collapse show">
                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table mb-0" id="expenseTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                    <th>Category</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for expense in month_expenses.list %}
                                <tr>
                                    <td>{{ expense.date|date:"d M Y" }}</td>
                                    <td>₹{{ expense.amount }}</td>
                                    <td>{{ expense.description }}</td>
                                    <td>{{ expense.category }}</td>
                                    <td>
                                        <a href="{% url 'finances:edit_expense' expense.id %}" class="btn btn-warning btn-custom">
                                            <i class="fas fa-edit me-1"></i> Edit
                                        </a>
                                        <a href="{% url 'finances:delete_expense' expense.id %}" class="btn btn-danger btn-custom" onclick="return confirmDelete('expense')">
                                            <i class="fas fa-trash me-1"></i> Delete
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="expense-group animate__animated animate__fadeIn">
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table mb-0">
                        <tbody>
                            <tr>
                                <td colspan="5" class="text-center">No expense entries found.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endfor %}

        <div class="pagination animate__animated animate__fadeIn">
            {% if expenses.has_previous %}
                <button onclick="location.href='?page={{ expenses.previous_page_number }}&month={{ request.GET.month }}&year={{ request.GET.year }}&category={{ request.GET.category }}'">
                    <i class="fas fa-chevron-left me-1"></i> Previous
                </button>
            {% endif %}
            
            <button class="active">{{ expenses.number }}</button>
            
            {% if expenses.has_next %}
                <button onclick="location.href='?page={{ expenses.next_page_number }}&month={{ request.GET.month }}&year={{ request.GET.year }}&category={{ request.GET.category }}'">
                    Next <i class="fas fa-chevron-right ms-1"></i>
                </button>
            {% endif %}
        </div>
    </div>

    <!-- Modal for PDF Export -->
    <div class="modal fade" id="pdfExportModal" tabindex="-1" aria-labelledby="pdfExportModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pdfExportModalLabel">Export Financial Report</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="pdfExportForm">
                        <div class="mb-3">
                            <label for="reportType" class="form-label">Report Type</label>
                            <select class="form-select" id="reportType" name="reportType">
                                <option value="all">Complete Financial Report</option>
                                <option value="income">Income Report Only</option>
                                <option value="expense">Expense Report Only</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="startDate" class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="startDate" name="startDate">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="endDate" class="form-label">End Date</label>
                                    <input type="date" class="form-control" id="endDate" name="endDate">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="includeCharts" class="form-label">Include Charts</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="true" id="includeCharts" name="includeCharts" checked>
                                <label class="form-check-label" for="includeCharts">
                                    Yes, include visual charts
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="includeSummary" class="form-label">Include Summary</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="true" id="includeSummary" name="includeSummary" checked>
                                <label class="form-check-label" for="includeSummary">
                                    Yes, include financial summary
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="generatePdfBtn">Generate PDF</button>
                </div>
            </div>
        </div>
    </div>

    {{ chart_labels|json_script:"chart-labels" }}
    {{ chart_income|json_script:"chart-income" }}
    {{ chart_expenses|json_script:"chart-expenses" }}
    {{ categories|json_script:"chart-categories" }}
    {{ income_data|json_script:"chart-income-data" }}
    {{ expense_data|json_script:"chart-expense-data" }}    
    <footer class="footer">
        <div class="container">
            <p>&copy; 2021 FinSage. All Rights Reserved.</p>
        </div>
    </footer>

    <!-- External JavaScript Files -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="{% static 'js/dash.js' %}"></script>
    <script>
        function closeMessage(closeBtn) {
            let messageDiv = closeBtn.parentElement;
            messageDiv.classList.add("animate__fadeOut"); 
            setTimeout(() => messageDiv.style.display = "none", 100);
        }
    
        function confirmDelete(type) {
            return confirm(`Are you sure you want to delete this ${type}?`);
        }
    
        document.addEventListener('DOMContentLoaded', function() {
            // Display active filters
            function displayActiveFilters() {
                const urlParams = new URLSearchParams(window.location.search);
                const activeFilters = document.getElementById('activeFilters');
                activeFilters.innerHTML = '';
                
                if (urlParams.toString()) {
                    const filterBox = document.createElement('div');
                    filterBox.className = 'active-filter-box';
                    
                    const searchType = urlParams.get('search_type') || 'expense';
                    
                    if (urlParams.get('month')) {
                        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                        const monthValue = parseInt(urlParams.get('month')) - 1;
                        const monthName = monthNames[monthValue];
                        
                        const filterTag = document.createElement('span');
                        filterTag.className = 'filter-tag';
                        filterTag.innerHTML = `Month: ${monthName} <i class="fas fa-times"></i>`;
                        filterTag.onclick = () => {
                            urlParams.delete('month');
                            window.location.search = urlParams.toString();
                        };
                        filterBox.appendChild(filterTag);
                    }
                    
                    if (urlParams.get('year')) {
                        const filterTag = document.createElement('span');
                        filterTag.className = 'filter-tag';
                        filterTag.innerHTML = `Year: ${urlParams.get('year')} <i class="fas fa-times"></i>`;
                        filterTag.onclick = () => {
                            urlParams.delete('year');
                            window.location.search = urlParams.toString();
                        };
                        filterBox.appendChild(filterTag);
                    }
                    
                    if (urlParams.get('date')) {
                        const filterTag = document.createElement('span');
                        filterTag.className = 'filter-tag';
                        filterTag.innerHTML = `Date: ${urlParams.get('date')} <i class="fas fa-times"></i>`;
                        filterTag.onclick = () => {
                            urlParams.delete('date');
                            window.location.search = urlParams.toString();
                        };
                        filterBox.appendChild(filterTag);
                    }
                    
                    if (urlParams.get('category')) {
                        const filterTag = document.createElement('span');
                        filterTag.className = 'filter-tag';
                        filterTag.innerHTML = `Category: ${urlParams.get('category')} <i class="fas fa-times"></i>`;
                        filterTag.onclick = () => {
                            urlParams.delete('category');
                            window.location.search = urlParams.toString();
                        };
                        filterBox.appendChild(filterTag);
                    }
                    
                    if (urlParams.get('min_amount')) {
                        const filterTag = document.createElement('span');
                        filterTag.className = 'filter-tag';
                        filterTag.innerHTML = `Min Amount: ₹${urlParams.get('min_amount')} <i class="fas fa-times"></i>`;
                        filterTag.onclick = () => {
                            urlParams.delete('min_amount');
                            window.location.search = urlParams.toString();
                        };
                        filterBox.appendChild(filterTag);
                    }
                    
                    if (urlParams.get('max_amount')) {
                        const filterTag = document.createElement('span');
                        filterTag.className = 'filter-tag';
                        filterTag.innerHTML = `Max Amount: ₹${urlParams.get('max_amount')} <i class="fas fa-times"></i>`;
                        filterTag.onclick = () => {
                            urlParams.delete('max_amount');
                            window.location.search = urlParams.toString();
                        };
                        filterBox.appendChild(filterTag);
                    }
                    
                    if (urlParams.get('keyword')) {
                        const filterTag = document.createElement('span');
                        filterTag.className = 'filter-tag';
                        filterTag.innerHTML = `Keyword: ${urlParams.get('keyword')} <i class="fas fa-times"></i>`;
                        filterTag.onclick = () => {
                            urlParams.delete('keyword');
                            window.location.search = urlParams.toString();
                        };
                        filterBox.appendChild(filterTag);
                    }
                    
                    if (filterBox.children.length > 0) {
                        const clearAllButton = document.createElement('button');
                        clearAllButton.className = 'clear-filters-btn';
                        clearAllButton.innerHTML = '<i class="fas fa-times-circle me-1"></i> Clear All Filters';
                        clearAllButton.onclick = () => {
                            window.location.href = window.location.pathname;
                        };
                        
                        filterBox.appendChild(clearAllButton);
                        activeFilters.appendChild(filterBox);
                    }
                }
            }
            
            // Call to display active filters
            displayActiveFilters();
            
            // Export PDF functionality
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            const exportIncomeBtn = document.getElementById('exportIncomeBtn');
            const exportExpenseBtn = document.getElementById('exportExpenseBtn');
            const pdfExportModal = new bootstrap.Modal(document.getElementById('pdfExportModal'));
            
            // Set current date as default for report date range
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('startDate').valueAsDate = firstDayOfMonth;
            document.getElementById('endDate').valueAsDate = today;
            
            // Function to handle opening the PDF export modal with default values
            function openPdfExportModal(reportType) {
                document.getElementById('reportType').value = reportType;
                pdfExportModal.show();
            }
            
            // Event listeners for export buttons
            exportPdfBtn.addEventListener('click', () => openPdfExportModal('all'));
            exportIncomeBtn.addEventListener('click', () => openPdfExportModal('income'));
            exportExpenseBtn.addEventListener('click', () => openPdfExportModal('expense'));
            
            // Generate PDF functionality
            document.getElementById('generatePdfBtn').addEventListener('click', async function() {
                const reportType = document.getElementById('reportType').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const includeCharts = document.getElementById('includeCharts').checked;
                const includeSummary = document.getElementById('includeSummary').checked;
                
                // Initialize PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'pt', 'a4');
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 40;
                let yPosition = margin;
                
                // Add title
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                
                // Determine report title based on type
                let reportTitle;
                switch(reportType) {
                    case 'income':
                        reportTitle = 'Income Report';
                        break;
                    case 'expense':
                        reportTitle = 'Expense Report';
                        break;
                    default:
                        reportTitle = 'Financial Report';
                }
                
                doc.text(reportTitle, pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 30;
                
                // Add date range
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                const dateRangeText = `Date Range: ${formatDate(startDate)} to ${formatDate(endDate)}`;
                doc.text(dateRangeText, pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 30;
                
                // Add summary information if requested
                if (includeSummary) {
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Financial Summary', margin, yPosition);
                    yPosition += 20;
                    
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    
                    // Get summary data from the page
                    const totalIncome = document.getElementById('income-counter').textContent;
                    const totalExpenses = document.getElementById('expense-counter').textContent;
                    const balance = document.getElementById('balance-counter').textContent;
                    
                    // Create summary table
                    const summaryData = [
                        ['Total Income', totalIncome],
                        ['Total Expenses', totalExpenses],
                        ['Balance', balance]
                    ];
                    
                    doc.autoTable({
                        startY: yPosition,
                        head: [['Item', 'Amount']],
                        body: summaryData,
                        theme: 'grid',
                        headStyles: { fillColor: [40, 167, 69] },
                        margin: { left: margin, right: margin },
                        styles: { overflow: 'linebreak' },
                        columnStyles: {
                            0: { cellWidth: 200 },
                            1: { cellWidth: 100 }
                        }
                    });
                    
                    yPosition = doc.previousAutoTable.finalY + 30;
                }
                
                // Add charts if requested
                if (includeCharts) {
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Charts', margin, yPosition);
                    yPosition += 20;
                    
                    // Function to add chart to PDF
                    async function addChartToPdf(chartId, title, docRef, yPos) {
                        const chart = document.getElementById(chartId);
                        if (!chart) return yPos;
                        
                        docRef.setFontSize(12);
                        docRef.setFont('helvetica', 'italic');
                        docRef.text(title, margin, yPos);
                        yPos += 15;
                        
                        const canvas = await html2canvas(chart);
                        const chartImgData = canvas.toDataURL('image/png');
                        
                        // Calculate the width and height to fit the page
                        const imgWidth = pageWidth - (margin * 2);
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;
                        
                        // Check if the chart will fit on the current page
                        if (yPos + imgHeight > pageHeight - margin) {
                            docRef.addPage();
                            yPos = margin;
                        }
                        
                        docRef.addImage(chartImgData, 'PNG', margin, yPos, imgWidth, imgHeight);
                        return yPos + imgHeight + 20;
                    }
                    
                    // Add category chart
                    yPosition = await addChartToPdf('categoryChart', 'Income and Expenses by Category', doc, yPosition);
                    
                    // Add trend chart
                    yPosition = await addChartToPdf('trendChart', 'Income vs Expenses Trend', doc, yPosition);
                }
                
                // Add data tables based on report type
                async function addDataTablesToPdf() {
                    // Add income table if requested
                    if (reportType === 'all' || reportType === 'income') {
                        // Add page break if needed
                        if (yPosition > pageHeight - 150) {
                            doc.addPage();
                            yPosition = margin;
                        }
                        
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Income Data', margin, yPosition);
                        yPosition += 20;
                        
                        const incomeTable = document.getElementById('incomeTable');
                        if (incomeTable) {
                            const incomeData = [];
                            const incomeRows = incomeTable.querySelectorAll('tbody tr');
                            
                            incomeRows.forEach(row => {
                                const cells = row.querySelectorAll('td');
                                if (cells.length >= 4) {
                                    incomeData.push([
                                        cells[2].textContent.trim(), // Date
                                        cells[0].textContent.trim(), // Amount
                                        cells[1].textContent.trim(), // Description
                                        cells[3].textContent.trim()  // Category
                                    ]);
                                }
                            });
                            
                            if (incomeData.length > 0) {
                                doc.autoTable({
                                    startY: yPosition,
                                    head: [['Date', 'Amount', 'Description', 'Category']],
                                    body: incomeData,
                                    theme: 'grid',
                                    headStyles: { fillColor: [40, 167, 69] },
                                    margin: { left: margin, right: margin },
                                    styles: { overflow: 'linebreak' }
                                });
                                
                                yPosition = doc.previousAutoTable.finalY + 30;
                            } else {
                                doc.setFontSize(12);
                                doc.setFont('helvetica', 'italic');
                                doc.text('No income data available', margin, yPosition);
                                yPosition += 20;
                            }
                        }
                    }
                    
                    // Add expense table if requested
                    if (reportType === 'all' || reportType === 'expense') {
                        // Add page break if needed
                        if (yPosition > pageHeight - 150) {
                            doc.addPage();
                            yPosition = margin;
                        }
                        
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Expense Data', margin, yPosition);
                        yPosition += 20;
                        
                        const expenseTables = document.querySelectorAll('#expenseTable');
                        if (expenseTables.length > 0) {
                            const expenseData = [];
                            
                            expenseTables.forEach(table => {
                                const expenseRows = table.querySelectorAll('tbody tr');
                                expenseRows.forEach(row => {
                                    const cells = row.querySelectorAll('td');
                                    if (cells.length >= 4) {
                                        expenseData.push([
                                            cells[0].textContent.trim(), // Date
                                            cells[1].textContent.trim(), // Amount
                                            cells[2].textContent.trim(), // Description
                                            cells[3].textContent.trim()  // Category
                                        ]);
                                    }
                                });
                            });
                            
                            if (expenseData.length > 0) {
                                doc.autoTable({
                                    startY: yPosition,
                                    head: [['Date', 'Amount', 'Description', 'Category']],
                                    body: expenseData,
                                    theme: 'grid',
                                    headStyles: { fillColor: [220, 53, 69] },
                                    margin: { left: margin, right: margin },
                                    styles: { overflow: 'linebreak' }
                                });
                                
                                yPosition = doc.previousAutoTable.finalY + 30;
                            } else {
                                doc.setFontSize(12);
                                doc.setFont('helvetica', 'italic');
                                doc.text('No expense data available', margin, yPosition);
                                yPosition += 20;
                            }
                        }
                    }
                    
                    // Add footer
                    const footerText = `Generated on ${formatDate(new Date().toISOString().split('T')[0])} by FinSage`;
                    const footerTextWidth = doc.getTextWidth(footerText);
                    
                    doc.setFontSize(10);
                    doc.setTextColor(100);
                    
                    // Add to all pages
                    const pageCount = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.text(footerText, pageWidth - margin - footerTextWidth, pageHeight - margin);
                        doc.text(`Page ${i} of ${pageCount}`, margin, pageHeight - margin);
                    }
                    
                    // Save the PDF
                    doc.save(`FinSage_${reportType}_Report_${formatDateFilename(new Date())}.pdf`);
                    
                    // Close the modal
                    pdfExportModal.hide();
                }
                
                // Call the function to add data tables
                addDataTablesToPdf();
            });
            
            // Helper function to format date for display
            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-IN', { 
                    day: 'numeric', 
                    month: 'short', 
                    year: 'numeric' 
                });
            }
            
            // Helper function to format date for filename
            function formatDateFilename(date) {
                return date.toISOString().split('T')[0].replace(/-/g, '');
            }
            
            // Trend Chart
            var ctx = document.getElementById('trendChart').getContext('2d');
            
            var chartLabels = JSON.parse(document.getElementById('chart-labels').textContent);
            var chartIncome = JSON.parse(document.getElementById('chart-income').textContent);
            var chartExpenses = JSON.parse(document.getElementById('chart-expenses').textContent);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [
                        {
                            label: 'Income',
                            data: chartIncome,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: true
                        },
                        {
                            label: 'Expenses',
                            data: chartExpenses,
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    var label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('en-IN', { 
                                            style: 'currency', 
                                            currency: 'INR',
                                            maximumFractionDigits: 0
                                        }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            
            // Category Chart
            var ctxCategory = document.getElementById('categoryChart').getContext('2d');
            
            var categories = JSON.parse(document.getElementById('chart-categories').textContent);
            var incomeData = JSON.parse(document.getElementById('chart-income-data').textContent);
            var expenseData = JSON.parse(document.getElementById('chart-expense-data').textContent);
            
            // Calculate net values for data labels
            var netValues = incomeData.map((income, index) => income - expenseData[index]);
            
            // Custom gradient backgrounds
            function createGradient(ctx, color1, color2) {
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, color1);
                gradient.addColorStop(1, color2);
                return gradient;
            }
            
            const incomeGradient = createGradient(ctxCategory, 'rgba(40, 167, 69, 0.8)', 'rgba(40, 167, 69, 0.3)');
            const expenseGradient = createGradient(ctxCategory, 'rgba(220, 53, 69, 0.8)', 'rgba(220, 53, 69, 0.3)');
            new Chart(ctxCategory, {
            type: 'bar',
            data: {
                labels: categories,
                datasets: [
                    {
                        label: 'Income',
                        data: incomeData,
                        backgroundColor: incomeGradient,
                        borderColor: '#28a745',
                        borderWidth: 2,
                        borderRadius: 6,
                        hoverBorderWidth: 3,
                        hoverBorderColor: '#1d9438'
                    },
                    {
                        label: 'Expenses',
                        data: expenseData,
                        backgroundColor: expenseGradient,
                        borderColor: '#dc3545',
                        borderWidth: 2,
                        borderRadius: 6,
                        hoverBorderWidth: 3,
                        hoverBorderColor: '#c82333'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                },
                layout: {
                    padding: {
                        top: 10,
                        right: 25,
                        bottom: 10,
                        left: 25
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(200, 200, 200, 0.2)',
                            drawBorder: false
                        },
                        ticks: {
                            callback: function(value) {
                                return new Intl.NumberFormat('en-IN', { 
                                    style: 'currency', 
                                    currency: 'INR',
                                    maximumFractionDigits: 0
                                }).format(value);
                            },
                            font: {
                                weight: 'bold'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Amount (₹)',
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            padding: {top: 10, bottom: 10}
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                weight: 'bold'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Category',
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            padding: {top: 10, bottom: 10}
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            boxWidth: 15,
                            usePointStyle: true,
                            pointStyle: 'rectRounded',
                            padding: 20,
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 14
                        },
                        padding: 12,
                        cornerRadius: 6,
                        callbacks: {
                            label: function(context) {
                                var label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('en-IN', { 
                                        style: 'currency', 
                                        currency: 'INR',
                                        maximumFractionDigits: 0
                                    }).format(context.parsed.y);
                                }
                                return label;
                            },
                            afterBody: function(tooltipItems) {
                                const idx = tooltipItems[0].dataIndex;
                                const net = netValues[idx];
                                const netFormatted = new Intl.NumberFormat('en-IN', { 
                                    style: 'currency', 
                                    currency: 'INR',
                                    maximumFractionDigits: 0
                                }).format(net);
                                
                                return `Net: ${netFormatted} (${net >= 0 ? '+' : ''}${(net / expenseData[idx] * 100).toFixed(1)}%)`;
                            }
                        }
                    },
                    datalabels: {
                        display: function(context) {
                            return context.dataset.data[context.dataIndex] > 0;
                        },
                        color: function(context) {
                            return context.dataset.borderColor;
                        },
                        font: {
                            weight: 'bold'
                        },
                        formatter: function(value) {
                            if (value > 10000) {
                                return new Intl.NumberFormat('en-IN', { 
                                    style: 'currency', 
                                    currency: 'INR',
                                    notation: 'compact',
                                    compactDisplay: 'short',
                                    maximumFractionDigits: 1
                                }).format(value);
                            }
                            return '';
                        }
                    }
                }
            },
            plugins: [ChartDataLabels] // Make sure to include this library in your HTML
        });
    
        // FAB Button functionality - Enhanced
        const fabButton = document.getElementById('fabButton');
        const fabOptions = document.getElementById('fabOptions');
    
        if (fabButton) {
            fabButton.addEventListener('click', function() {
                fabOptions.classList.toggle('active');
            });
            
            // Auto-hide FAB options when clicking elsewhere
            document.addEventListener('click', function(event) {
                if (!fabButton.contains(event.target) && !fabOptions.contains(event.target)) {
                    fabOptions.classList.remove('active');
                }
            });
        }
    
        // Add download functionality
        document.getElementById('downloadChart').addEventListener('click', function() {
            const canvas = document.getElementById('categoryChart');
            const image = canvas.toDataURL('image/png', 1.0);
            const link = document.createElement('a');
            link.download = 'category-financial-chart.png';
            link.href = image;
            link.click();
        });
    
        // Add chart animation refresh button
        document.getElementById('refreshChart').addEventListener('click', function() {
            const chart = Chart.getChart('categoryChart');
            chart.update('none');
            chart.options.animation.duration = 1000;
            chart.reset();
            setTimeout(() => {
                chart.update();
            }, 100);
        });
    });
    </script>
</body>
</html>
                