{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - FinSage</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" type="text/css" href="{% static 'css/dash.css' %}">
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Your External JavaScript File -->
    <script src="{% static 'js/dash.js' %}"></script>
</head>
<body>
    <header class="header">
        <div class="logo-container">
            <span class="brand-name">FinSage</span>
        </div>
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle text-white" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user-circle me-1"></i> My Account
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="{% url 'finances:upload_bill' %}"><i class="fas fa-receipt me-2"></i>Upload Bill</a></li>
                                <li><a class="dropdown-item" href="{% url 'finances:export_expenses' %}"><i class="fas fa-file-export me-2"></i>Export Expenses</a></li>
                                <li><a class="dropdown-item" href="{% url 'finances:add_income' %}"><i class="fas fa-plus-circle me-2"></i>Add Income</a></li>
                                <li><a class="dropdown-item" href="{% url 'finances:add_expense' %}"><i class="fas fa-minus-circle me-2"></i>Add Expense</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="/logout"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <div class="container">
        <h1 class="section-title animate__animated animate__fadeIn"> Dashboard</h1>

        <div id="message-container" class="message-container">
            {% if messages %}
                {% for message in messages %}
                    {% if forloop.last %}
                        <div class="message {{ message.tags }} animate__animated animate__fadeIn">
                            <span class="message-close" onclick="closeMessage(this)">&times;</span>
                            {{ message }}
                        </div>
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>

        <div class="stats-cards animate__animated animate__fadeInUp">
            <div class="stat-card" id="income-card">
                <h4>Total Income</h4>
                <div class="amount" id="income-counter">₹{{ total_income }}</div>
                <!-- <div class="mt-2 text-success"><i class="fas fa-arrow-up me-1"></i><span id="income-percent">4.2</span>% from last month</div> -->
            </div>
            <div class="stat-card" id="expense-card">
                <h4>Total Expenses</h4>
                <div class="amount" id="expense-counter">₹{{ total_expenses }}</div>
                <!-- <div class="mt-2 text-danger"><i class="fas fa-arrow-up me-1"></i><span id="expense-percent">3.1</span>% from last month</div> -->
            </div>
            <div class="stat-card" id="balance-card">
                <h4>Balance</h4>
                <div class="amount" id="balance-counter">₹{{ balance }}</div>
                <!-- <div class="mt-2" id="balance-trend">
                    <span class="text-success"><i class="fas fa-arrow-up me-1"></i>5.3% from last month</span>
                </div> -->
            </div>
        </div>
        
        <!-- Charts Row -->
        <div class="row mb-4 animate__animated animate__fadeIn">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>Monthly Expenses by Category</h5>
                    <canvas id="categoryChart" width="400" height="250"></canvas>
                    <div class="category-legend" id="categoryLegend"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>Income vs Expenses Trend</h5>
                    <canvas id="trendChart" width="400" height="250"></canvas>
                </div>
            </div>
        </div>

        <h3 class="section-title animate__animated animate__fadeIn">Income Entries</h3>
        <div class="table-container animate__animated animate__fadeInUp">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Amount</th>
                            <th>Description</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if incomes %}
                            {% for income in incomes %}
                                <tr class="animate__animated animate__fadeIn" style="--animate-delay: {{ forloop.counter }}00ms">
                                    <td>₹{{ income.amount }}</td>
                                    <td>{{ income.description }}</td>
                                    <td>{{ income.date }}</td>
                                    <td>
                                        <a href="{% url 'finances:edit_income' income.id %}" class="btn btn-warning btn-custom">
                                            <i class="fas fa-edit me-1"></i> Edit
                                        </a>
                                        <a href="{% url 'finances:delete_income' income.id %}" class="btn btn-danger btn-custom" onclick="return confirmDelete('income')">
                                            <i class="fas fa-trash me-1"></i> Delete
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="4" class="text-center">No income entries found.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <h3 class="section-title mt-4 animate__animated animate__fadeIn">Expense Management</h3>

        <div id="search-section" class="search-container p-3 animate__animated animate__fadeIn">
            <h5 class="mb-3"><i class="fas fa-filter me-2"></i>Filter Expenses</h5>
            <form method="GET" action="" class="row g-2">
                <div class="col-md-4">
                    <label for="month" class="form-label">Month</label>
                    <select name="month" id="month" class="form-select">
                        <option value="">Default</option>
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
        
                <div class="col-md-4">
                    <label for="year" class="form-label">Year</label>
                    <select name="year" id="year" class="form-select">
                        <option value="">All Years</option>
                        {% for year in available_years %}
                            <option value="{{ year }}">{{ year }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-4">
                    <label for="date" class="form-label">Date</label>
                    <input type="date" name="date" id="date" class="form-control" placeholder="Search by date" value="{{ request.GET.date|default:'' }}">
                </div>
        
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100"><i class="fas fa-search me-2"></i> Search</button>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <a href="{% url 'finances:dashboard' %}" class="btn btn-secondary w-100">
                        <i class="fas fa-sync-alt me-2"></i> Reset
                    </a>
                </div>
            </form>

            <div class="active-filters mt-3" id="activeFilters">
                <!-- Active filters will be displayed here -->
            </div>
        </div>
    
        {% regroup expenses by month_year as expense_list %}
        
        {% for month_expenses in expense_list %}
        <div class="expense-group animate__animated animate__fadeIn" style="--animate-delay: {{ forloop.counter }}00ms">
            <div id="expense-{{ forloop.counter }}" class="collapse show">
                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                    <th>Category</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for expense in month_expenses.list %}
                                <tr>
                                    <td>{{ expense.date|date:"d M Y" }}</td>
                                    <td>₹{{ expense.amount }}</td>
                                    <td>{{ expense.description }}</td>
                                    <td>{{ expense.category.name }}</td>
                                    <td>
                                        <a href="{% url 'finances:edit_expense' expense.id %}" class="btn btn-warning btn-custom">
                                            <i class="fas fa-edit me-1"></i> Edit
                                        </a>
                                        <a href="{% url 'finances:delete_expense' expense.id %}" class="btn btn-danger btn-custom" onclick="return confirmDelete('expense')">
                                            <i class="fas fa-trash me-1"></i> Delete
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="expense-group animate__animated animate__fadeIn">
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table mb-0">
                        <tbody>
                            <tr>
                                <td colspan="5" class="text-center">No expense entries found.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endfor %}

        <div class="pagination animate__animated animate__fadeIn">
            {% if expenses.has_previous %}
                <button onclick="location.href='?page={{ expenses.previous_page_number }}&month={{ request.GET.month }}&year={{ request.GET.year }}&category={{ request.GET.category }}'">
                    <i class="fas fa-chevron-left me-1"></i> Previous
                </button>
            {% endif %}
            
            <button class="active">{{ expenses.number }}</button>
            
            {% if expenses.has_next %}
                <button onclick="location.href='?page={{ expenses.next_page_number }}&month={{ request.GET.month }}&year={{ request.GET.year }}&category={{ request.GET.category }}'">
                    Next <i class="fas fa-chevron-right ms-1"></i>
                </button>
            {% endif %}
        </div>
    </div>

    <!-- Floating Action Button for Quick Actions -->
    <div class="fab-container">
        <div class="fab-button" id="fabButton">
            <i class="fas fa-plus"></i>
        </div>
        <div class="fab-options" id="fabOptions">
            <div class="fab-option" onclick="location.href"="{% url 'finances:add_income' %}">
                <i class="fas fa-plus-circle text-success"></i> Add Income
            </div>
            <div class="fab-option" onclick="location.href"="{% url 'finances:add_expense' %}">
                <i class="fas fa-minus-circle text-danger"></i> Add Expense
            </div>
            <div class="fab-option" onclick="location.href"="{% url 'finances:upload_bill' %}">
                <i class="fas fa-receipt text-primary"></i> Upload Bill
            </div>
            <div class="fab-option" onclick="location.href"="{% url 'finances:export_expenses' %}">
                <i class="fas fa-file-export text-info"></i> Export Data
            </div>
        </div>
    </div>

{{ chart_labels|json_script:"chart-labels" }}
{{ chart_income|json_script:"chart-income" }}
{{ chart_expenses|json_script:"chart-expenses" }}

<script>
function closeMessage(closeBtn) {
    let messageDiv = closeBtn.parentElement;
    messageDiv.classList.add("animate__fadeOut"); 
    setTimeout(() => messageDiv.style.display = "none", 100);
}

function confirmDelete(type) {
    return confirm(`Are you sure you want to delete this ${type}?`);
}

document.addEventListener('DOMContentLoaded', function() {
    // Trend Chart
    var ctx = document.getElementById('trendChart').getContext('2d');
    
    var chartLabels = JSON.parse(document.getElementById('chart-labels').textContent);
    var chartIncome = JSON.parse(document.getElementById('chart-income').textContent);
    var chartExpenses = JSON.parse(document.getElementById('chart-expenses').textContent);
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartLabels,
            datasets: [
                {
                    label: 'Income',
                    data: chartIncome,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    borderWidth: 2,
                    tension: 0.1,
                    fill: true
                },
                {
                    label: 'Expenses',
                    data: chartExpenses,
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    borderWidth: 2,
                    tension: 0.1,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Amount'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Month'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            var label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += new Intl.NumberFormat('en-IN', { 
                                    style: 'currency', 
                                    currency: 'INR',
                                    maximumFractionDigits: 0
                                }).format(context.parsed.y);
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
    
    // FAB Button functionality
    const fabButton = document.getElementById('fabButton');
    const fabOptions = document.getElementById('fabOptions');
    
    if (fabButton) {
        fabButton.addEventListener('click', function() {
            fabOptions.classList.toggle('active');
        });
    }
});
</script>
</body>
</html>